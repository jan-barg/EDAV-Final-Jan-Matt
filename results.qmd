# Results
```{r}
#| label: setup
#| context: setup
#| include: false

library(dplyr)
library(readr)
library(tidyr)
library(tibble)
library(ggplot2)
library(forcats)
library(scales)
library(glue)
library(gt)

library(gganimate)
library(gifski)
library(transformr)
library(redav)

# mapping
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)


# you'll load master_long/master_wide later when needed
data_dir  <- "./data-gathering/data/clean"
end_year  <- 2023L

master_long <- readr::read_csv(
  file.path(data_dir, "master_long.csv"),
  col_types = readr::cols(
    country  = readr::col_character(),
    year     = readr::col_integer(),
    variable = readr::col_character(),
    value    = readr::col_double()
  )
)



country_lookup <- tibble::tibble(
  country      = c("USA", "CAN", "DEU", "SWE", "POL",
                   "IND", "CHN", "JPN", "KOR",
                   "NGA", "ZAF", "BRA", "AUS"),
  country_name = c("United States", "Canada", "Germany", "Sweden", "Poland",
                   "India", "China", "Japan", "South Korea",
                   "Nigeria", "South Africa", "Brazil", "Australia"),
  region       = c("North America", "North America",
                   "Europe", "Europe", "Europe",
                   "Asia", "Asia", "Asia", "Asia",
                   "Africa", "Africa",
                   "South America",
                   "Oceania")
) |>
  mutate(
    country_name = factor(
      country_name,
      levels = c(
        "United States", "Canada",
        "Germany", "Sweden", "Poland",
        "India", "China", "Japan", "South Korea",
        "Nigeria", "South Africa",
        "Brazil",
        "Australia"
      )
    )
  )
```
## Global fertility trajectories
### Fertility over time
```{r}
#| label: fertility-faceted
#| fig-cap: "Fertility rate trajectories (births per woman) for 13 selected countries. The dashed line marks the replacement level of 2.1 births per woman."


fertility_data <- master_long |>
  filter(
    variable == "fertility_rate",
    year >= 1960,
    year <= end_year
  ) |>
  left_join(country_lookup, by = "country")

country_order <- fertility_data |>
  group_by(country_name) |>
  summarize(avg_fertility = mean(value, na.rm = TRUE)) |>
  arrange(desc(avg_fertility)) |>
  pull(country_name)

fertility_long <- master_long |>
  filter(
    variable == "fertility_rate",
    year >= 1960,
    year <= end_year
  ) |>
  left_join(country_lookup, by = "country") |>
  # use the same ordering as in the heatmap
  mutate(
    country_name = factor(country_name, levels = (country_order))
  )

ggplot(fertility_long, aes(x = year, y = value)) +
  # replacement line
  geom_hline(
    yintercept = 2.1,
    linetype   = "dashed",
    color      = "grey40"
  ) +
  geom_line(color = "#2c7fb8", linewidth = 0.7) +
  facet_wrap(~ country_name, ncol = 4) +
  scale_y_continuous(
    "Fertility rate (births per woman)",
    limits = c(0, NA)
  ) +
  scale_x_continuous(
    "Year",
    breaks = seq(1960, 2020, by = 20)
  ) +
  theme_minimal(base_size = 12) +
  theme(
    strip.text = element_text(face = "bold"),
    plot.title = element_text(face = "bold", size = 16),
    panel.grid.minor = element_blank()
  ) +
  labs(
    title = "Fertility has declined across all selected countries",
    subtitle = "Dashed line shows the replacement level of 2.1 births per woman"
  )
```

For every country in the analysis, we see a decline in fertility rates between 1960 and 2023. While the change varies across the countries, it is interesting to see that all countries except Japan had fertility levels above the replacement rate - and only Nigeria and South Africa (barely!) managed to sustain fertility levels above 2.1 births per woman. The pattern is strikingly similar for Germany, Japan, Sweden, and Poland, which were just around replacement level 65 years ago, and have fallen much below it ever since.
The decline in fertility is quicker in the US and Australia, and even more so across the first 5 countries in the figure above.
Out of these, China marks an interesting case: it is the only country that exhibited significant positive growth in fertility rates throughout the 60+ year period. This could stem from several reasons, but the most likely cause seems to be the end of the 1959-1961 Great Chinese Famine. After living conditions stabilized in the country, the citizens were more likely to decide to have children. Because China had not yet implemented fertility-control policies, this rebound appears prominently in the data.

### Fertility rate heat map

```{r}
#| label: fertility-heatmap
#| fig-cap: "Fertility rates across countries and years, with countries ordered by average fertility."



# compute average fertility over the entire period

fertility_data <- fertility_data |>
  mutate(
    country_name = factor(country_name, levels = rev(country_order))
  )

ggplot(fertility_data, aes(x = year, y = country_name, fill = value)) +
  geom_tile() +
  scale_x_continuous(
    "Year",
    breaks = seq(1960, 2020, by = 10),
    expand = expansion(mult = c(0, 0))
  ) +
  scale_fill_viridis_c(
    name = "Births per\nwoman",
    option = "magma",
    direction = -1
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y  = element_text(face = "bold"),
    plot.title   = element_text(size = 16, face = "bold")
  ) +
  labs(
    title = "Fertility is converging across countries over time"
  )


```
In the fertility heat map, we see patterns that converge towards lower fertility, with some interruptions of darker shades. Most notably, Nigeria, which exhibits by far the highest fertility of the 13 countries, is seeing a decline in its fertility. On the other hand, South Korea has been seeing the lowest rates of child birth since the start of the millennium.

## Fertility vs. other indicators

### GDP per capita over time
```{r}
#| label: gdp-faceted-linear
#| fig-cap: "Constant GDP per capita (linear scale) for 13 selected countries."

# compute median GDP per capita per country for ordering
gdp_order <- master_long |>
  filter(
    variable == "gdp_capita_const",
    year >= 1960,
    year <= end_year
  ) |>
  left_join(country_lookup, by = "country") |>
  group_by(country_name) |>
  summarize(median_gdp = median(value, na.rm = TRUE)) |>
  arrange(desc(median_gdp)) |>
  pull(country_name)

# apply ordering
gdp_long <- master_long |>
  filter(
    variable == "gdp_capita_const",
    year >= 1960,
    year <= end_year
  ) |>
  left_join(country_lookup, by = "country") |>
  mutate(country_name = factor(country_name, levels = gdp_order))

ggplot(gdp_long, aes(x = year, y = value)) +
  geom_line(color = "#1b9e77", linewidth = 0.7) +
  facet_wrap(~ country_name, ncol = 4, scales = "free_y") +
  scale_y_continuous(
    "Constant GDP per capita (USD)",
    labels = scales::label_number(accuracy = 1, big.mark = ",")
  ) +
  scale_x_continuous(
    "Year",
    breaks = seq(1960, 2020, by = 20)
  ) +
  theme_minimal(base_size = 12) +
  theme(
    strip.text       = element_text(face = "bold"),
    plot.title       = element_text(face = "bold", size = 16),
    panel.grid.minor = element_blank()
  ) +
  labs(
    title = "GDP per capita over time"
  )

```
For all the 13 countries, excluding South Africa and Nigeria, we see continuous GDP per capita growth.
The United States, Canada, Sweden, Australia, Germany, and Japan all show steady and sustained income growth over the entire period. South Korea stands out as the strongest “growth miracle,” rising from extremely low income levels in 1960 to high-income status by 2020.
Middle-income countries such as Brazil and South Africa show more uneven patterns: periods of growth followed by stagnation or declines, reflecting political and economic instability. Nigeria’s GDP per capita is highly volatile, with several swings, likely caused by oil price cycles and structural instability within the country.
Nevertheless, each country has much higher GDP per capita in 2023 than in 1960.

NOTE: We tried to group countries into three GDP tiers and give each tier its own y-scale using ggh4x. Although the method should work in theory, it produced layout glitches (empty panels, misaligned strips, overlapping axes) in our setup. After several failed fixes, we reverted to a simpler, reliable approach: a standard facet plot with countries ordered by median GDP.

### Fertility vs GDP per capita

```{r}

#| label: fert-gdp-facets
#| fig-cap: "Relationship between fertility and GDP per capita, one panel per country."

fert_gdp <- master_long |>
  filter(
    variable %in% c("fertility_rate", "gdp_capita_const"),
    year >= 1960,
    year <= end_year
  ) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(names_from = variable, values_from = value) |>
  left_join(country_lookup, by = "country") |>
  filter(!is.na(fertility_rate), !is.na(gdp_capita_const))

ggplot(fert_gdp, aes(x = gdp_capita_const, y = fertility_rate)) +
  geom_point(alpha = 0.4, color = "#2c7fb8", size = 1) +
  geom_smooth(method = "loess", se = FALSE, linewidth = 0.7, color = "#d95f02") +
  facet_wrap(~ country_name, scales = "free") +
  scale_x_log10(
    "Constant GDP per capita (log scale)",
    labels = scales::label_number(scale_cut = scales::cut_si(""))
  ) +
  scale_y_continuous("Fertility rate (births per woman)") +
  theme_minimal(base_size = 12) +
  theme(
    strip.text = element_text(face = "bold"),
    plot.title = element_text(size = 16, face = "bold")
  ) +
  labs(
    title = "Fertility declines as GDP per capita rises",
    subtitle = "Each panel shows a country's trajectory across 1960–2023"
  )

```
When plotting Fertility Rates vs GDP per capita, we see constant decline for most countries. This does not necessarily imply causation, as shown by South Africa and Nigeria: the two countries that experienced high volatility exhibit high irregularity in the plotted patterns, showing that quick significant changes in GDP per capita do not go together with similarly swift changes in fertility rates.

```{r}
# #| label: gapminder-fertility-gdp
# #| eval: true
# #| message: false
# #| warning: false
# 
# library(gganimate)
# library(gifski)
# library(dplyr)
# 
# gapminder_data <- master_long |>
#   filter(
#     variable %in% c("fertility_rate", "gdp_capita_const", "total_population"),
#     year >= 1960,
#     year <= end_year
#   ) |>
#   select(country, year, variable, value) |>
#   tidyr::pivot_wider(
#     names_from  = variable,
#     values_from = value
#   ) |>
#   left_join(country_lookup, by = "country") |>
#   # keep rows with both fertility & GDP present
#   filter(!is.na(fertility_rate), !is.na(gdp_capita_const))
# 
# # pull out Nigeria rows (might be 0 if data is missing!)
# nigeria_data <- gapminder_data |>
#   filter(country == "Nigeria")
# 
# # base plot
# p_gapminder <- ggplot(
#   gapminder_data,
#   aes(
#     x     = gdp_capita_const,
#     y     = fertility_rate,
#     size  = total_population / 1e6,   # millions
#     color = region,
#     group = country
#   )
# ) +
#   geom_point(alpha = 0.6) +
#   scale_x_log10(
#     "Constant GDP per capita (log scale)",
#     labels = scales::label_number(scale_cut = scales::cut_si(""))
#   ) +
#   scale_y_continuous(
#     "Fertility rate (births per woman)",
#     limits = c(0, NA)
#   ) +
#   scale_size_continuous(
#     name  = "Population (millions)",
#     range = c(2, 10),
#     guide = "legend"
#   ) +
#   theme_minimal(base_size = 12) +
#   theme(
#     legend.position = "right",
#     plot.title      = element_text(size = 16, face = "bold"),
#     plot.subtitle   = element_text(size = 11)
#   ) +
#   labs(
#     title    = "Fertility vs GDP per Capita Over Time",
#     subtitle = "Year: {frame_time}",
#     color    = "Region"
#   )
# 
# # only add highlight + label if Nigeria actually has data
# if (nrow(nigeria_data) > 0) {
#   p_gapminder <- p_gapminder +
#     geom_point(
#       data  = nigeria_data,
#       aes(
#         x     = gdp_capita_const,
#         y     = fertility_rate,
#         size  = total_population / 1e6,
#         group = country
#       ),
#       inherit.aes = FALSE,
#       shape = 21,
#       fill  = "gold",
#       color = "black",
#       stroke = 1.1,
#       alpha  = 0.95,
#       show.legend = FALSE
#     ) +
#     geom_text(
#       data  = nigeria_data,
#       aes(
#         x     = gdp_capita_const,
#         y     = fertility_rate,
#         label = "Nigeria",
#         group = country
#       ),
#       inherit.aes = FALSE,
#       vjust = -1,
#       fontface = "bold",
#       show.legend = FALSE
#     )
# }
# 
# p_gapminder <- p_gapminder +
#   transition_time(year) +
#   ease_aes("linear")
# 
# # animate and save as GIF
# anim <- animate(
#   p_gapminder,
#   renderer = gifski_renderer(),
#   width    = 800,
#   height   = 600,
#   res      = 120,
#   fps      = 10,
#   duration = 12
# )
# 
# if (!dir.exists("figs")) dir.create("figs")
# anim_save("figs/gapminder_fertility_gdp.gif", animation = anim)


```
### Yearly snapshots of GDP per capita, population, and fertility

![](figs/gapminder_fertility_gdp.gif){fig-cap="Gapminder-style animation of fertility vs GDP per capita for the 13 selected countries, 1960–2023."}
In this animated graph, one can track changes in fertility, GDP per capita, and population over time. Each frame represents one year between 1960 and 2023, and each dot represents one country. As the dot's size grows, so does the country's population. As it moves to the right, its GDP per capita rises, and as it moves down, its fertility decreases. For example, the brown dot that jumps up and down at the beginning, then sharply falls towards the bottom is China - as the animations reflects its quick changes in fertility described above.
Most countries, particularly European and North American, seem to gravitate towards the bottom right corner (high GDP per capita and low fertility). They also, at least at the start of the animation, grow in size, indicating increasing population. As mentioned above, Nigeria (red dot at the top) stands as the clearest exception. 

### Fertility vs female labor force participation


```{r}
#| label: fert-flfpr-facets
#| fig-cap: "Relationship between fertility and female labor force participation, with time evolution shown by connected points."

fert_flfpr <- master_long |>
  filter(
    variable %in% c("fertility_rate", "flfpr"),
    year >= 1990,              # FLFPR starts around 1990
    year <= end_year
  ) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(names_from = variable, values_from = value) |>
  left_join(country_lookup, by = "country") |>
  filter(!is.na(fertility_rate), !is.na(flfpr))

ggplot(
  fert_flfpr,
  aes(
    x      = flfpr,
    y      = fertility_rate,
    group  = country_name
  )
) +
  geom_path(aes(color = year), linewidth = 0.7, alpha = 0.8) +
  geom_point(aes(color = year), size = 1.2, alpha = 0.8) +
  scale_color_viridis_c(
    name = "Year",
    option = "plasma"
  ) +
  facet_wrap(~ country_name, scales = "free") +
  scale_x_continuous("Female labor force participation rate (%)") +
  scale_y_continuous("Fertility rate (births per woman)") +
  theme_minimal(base_size = 12) +
  theme(
    strip.text   = element_text(face = "bold"),
    plot.title   = element_text(size = 16, face = "bold"),
    panel.grid.minor = element_blank()
  ) +
  labs(
    title    = "Fertility and female labor force participation",
    subtitle = "Each panel shows a country's trajectory since 1990, with color indicating year"
  )
```
When investigating fertility rates against female labor force participation rates (some speculate women tend to give less births the more they work), we cannot see any clear pattern. For example, in China, higher FLFPR coincides with higher fertility, while in Brazil, the opposite is the case. We therefore cannot confirm the hypothesis of female labor force participation having a negative effect on fertility rate.

### Fertility vs employment-to-population ratio
```{r}
#| label: fert-emp-facets
#| fig-cap: "Fertility and employment-to-population ratio"

fert_emp <- master_long |>
  filter(
    variable %in% c("fertility_rate", "emp_to_pop"),
    year >= 1991,                # employment-to-pop starts around 1991
    year <= end_year
  ) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(
    names_from  = variable,
    values_from = value
  ) |>
  left_join(country_lookup, by = "country") |>
  filter(
    !is.na(fertility_rate),
    !is.na(emp_to_pop)
  )

ggplot(
  fert_emp,
  aes(
    x     = emp_to_pop,
    y     = fertility_rate,
    group = country_name
  )
) +
  geom_path(aes(color = year), linewidth = 0.7, alpha = 0.8) +
  geom_point(aes(color = year), size = 1.2, alpha = 0.8) +
  scale_color_viridis_c(
    name   = "Year",
    option = "plasma"
  ) +
  facet_wrap(~ country_name, scales = "free") +
  scale_x_continuous("Employment-to-population ratio (%)") +
  scale_y_continuous("Fertility rate (births per woman)") +
  theme_minimal(base_size = 12) +
  theme(
    strip.text       = element_text(face = "bold"),
    plot.title       = element_text(size = 16, face = "bold"),
    panel.grid.minor = element_blank()
  ) +
  labs(
    title    = "Fertility vs overall employment rates",
    subtitle = "Each panel shows a country's trajectory since 1991, with color indicating year"
  )

```
As with the FLFPR vs fertility graph, the fertility vs overall employment rate graph does not allow us to draw any sensible conclusions. We therefore cannot speculate, either, that societies where more people work have higher or lower fertility rates.

## Migration, population growth, and fertility

```{r}
#| label: migration-pop-growth
#| fig-cap: "Standardized net migration and population growth over time for six selected countries."

# focus countries (by country code)
focus_countries <- c("USA", "CAN", "AUS", "POL", "JPN", "KOR")

pop_mig <- master_long |>
  filter(
    country %in% focus_countries,
    variable %in% c("total_population", "net_migration"),
    year >= 1960,
    year <= end_year
  ) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(
    names_from  = variable,
    values_from = value
  ) |>
  arrange(country, year) |>
  group_by(country) |>
  # population growth % from lagged population
  mutate(
    pop_growth_pct = (total_population - dplyr::lag(total_population)) /
      dplyr::lag(total_population) * 100
  ) |>
  ungroup() |>
  left_join(country_lookup, by = "country") |>
  filter(!is.na(pop_growth_pct), !is.na(net_migration))

# standardize within each country so we can overlay on one y-axis
pop_mig_scaled <- pop_mig |>
  group_by(country_name) |>
  mutate(
    mig_scaled  = as.numeric(scale(net_migration)),
    popg_scaled = as.numeric(scale(pop_growth_pct))
  ) |>
  ungroup() |>
  tidyr::pivot_longer(
    cols      = c(mig_scaled, popg_scaled),
    names_to  = "series",
    values_to = "value"
  ) |>
  mutate(
    series = dplyr::recode(
      series,
      mig_scaled  = "Net migration (standardized)",
      popg_scaled = "Population growth % (standardized)"
    )
  )

ggplot(pop_mig_scaled, aes(x = year, y = value, color = series)) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "grey60") +
  geom_line(linewidth = 0.8, alpha = 0.9) +
  facet_wrap(~ country_name, ncol = 3) +
  scale_x_continuous(
    "Year",
    breaks = seq(1960, 2020, by = 10)
  ) +
  scale_y_continuous("Standardized value") +
  scale_color_manual(
    name   = "",
    values = c(
      "Net migration (standardized)"          = "#1b9e77",
      "Population growth % (standardized)"    = "#d95f02"
    )
  ) +
  theme_minimal(base_size = 12) +
  theme(
    strip.text       = element_text(face = "bold"),
    plot.title       = element_text(size = 16, face = "bold"),
    panel.grid.minor = element_blank(),
    legend.position  = "bottom"
  ) +
  labs(
    title    = "Migration and population growth move together in immigration-heavy countries",
    subtitle = "Each panel shows standardized net migration and population growth rates since 1960"
  )
```
Note: Canada pop growth mimics migration patterns, Australia as well
Poland spike - Ukraininnans


```{r}
#| label: migration-pop-lagged
#| fig-cap: "Net migration today vs population growth in 1, 3, and 5 years, for six selected countries."

focus_countries <- c("USA", "CAN", "AUS", "POL", "JPN", "KOR")

pop_mig_lags <- master_long |>
  filter(
    country %in% focus_countries,
    variable %in% c("total_population", "net_migration"),
    year >= 1960,
    year <= end_year
  ) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(
    names_from  = variable,
    values_from = value
  ) |>
  arrange(country, year) |>
  group_by(country) |>
  mutate(
    pop_growth_pct = (total_population - dplyr::lag(total_population)) /
      dplyr::lag(total_population) * 100
  ) |>
  ungroup() |>
  left_join(country_lookup, by = "country")

# create future population growth for different lags
pop_mig_lags_long <- pop_mig_lags |>
  group_by(country) |>
  mutate(
    pop_growth_t1 = dplyr::lead(pop_growth_pct, 1),
    pop_growth_t3 = dplyr::lead(pop_growth_pct, 3),
    pop_growth_t5 = dplyr::lead(pop_growth_pct, 5)
  ) |>
  ungroup() |>
  select(
    country, country_name, year, net_migration,
    pop_growth_t1, pop_growth_t3, pop_growth_t5
  ) |>
  tidyr::pivot_longer(
    cols      = starts_with("pop_growth_t"),
    names_to  = "lag_label",
    values_to = "pop_growth_future"
  ) |>
  mutate(
    lag_years = dplyr::recode(
      lag_label,
      "pop_growth_t1" = "t + 1 year",
      "pop_growth_t3" = "t + 3 years",
      "pop_growth_t5" = "t + 5 years"
    ),
    lag_years = factor(
      lag_years,
      levels = c("t + 1 year", "t + 3 years", "t + 5 years")
    )
  ) |>
  filter(
    !is.na(net_migration),
    !is.na(pop_growth_future)
  )

ggplot(
  pop_mig_lags_long,
  aes(x = net_migration, y = pop_growth_future)
) +
  geom_point(alpha = 0.5, size = 1) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.7, color = "#d95f02") +
  facet_grid(lag_years ~ country_name, scales = "free") +
  scale_x_continuous(
    "Net migration",
    labels = scales::label_number(scale_cut = scales::cut_si(""))
  ) +
  scale_y_continuous("Population growth rate (%) in future year") +
  theme_minimal(base_size = 12) +
  theme(
    strip.text       = element_text(face = "bold"),
    plot.title       = element_text(size = 16, face = "bold"),
    panel.grid.minor = element_blank()
  ) +
  labs(
    title    = "Migration today and population growth tomorrow",
    subtitle = "Each point is a country-year; rows show different horizons (1, 3, and 5 years ahead)"
  )

```

This is pretty surprising: Australia and Canada actually experience high population growth from migratoin, but other coutries do not.

When you interpret this plot, emphasize:
✔ Immigration-heavy countries (Canada, Australia, USA)
Population growth tracks migration more clearly
Migration has meaningful demographic impact
Lines are flat or slightly positive
✔ Low-migration countries (Poland, Japan, Korea)
Population growth is dominated by aging and very low fertility
Migration is too small to offset this
Negative slopes emerge because migration & growth move for different reasons
✔ Conclusion
Migration matters only where migration numbers are large relative to the population.
In low-migration societies, migration is too small to affect total population change.

These plots combine levels with growth rates — this induces spurious correlations
This is the subtle but important statistical issue.
Migration is:
net_migration(t)
Population growth is:
(pop(t+1) – pop(t)) / pop(t)
Population(t) has long, slow-moving inertia.
Migration(t) is short-term and noisy.



## Correlation and structural patterns
```{r}
#| label: corr-data-prep
#| message: false
#| warning: false

corr_vars <- c(
  "fertility_rate",
  "gdp_capita_const",
  "flfpr",
  "emp_to_pop",
  "net_migration"
)

corr_data <- master_long |>
  filter(variable %in% corr_vars) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(
    names_from = variable,
    values_from = value
  ) |>
  left_join(country_lookup, by = "country")

corr_60_90 <- corr_data |>
  filter(year >= 1960, year <= 1990)

corr_90_23 <- corr_data |>
  filter(year > 1990, year <= 2023)

num_vars <- corr_vars   # fertility_rate, gdp_capita_const, flfpr, emp_to_pop, net_migration

cor_mat_60_90 <- corr_60_90 |>
  select(all_of(num_vars)) |>
  cor(use = "pairwise.complete.obs")

cor_mat_90_23 <- corr_90_23 |>
  select(all_of(num_vars)) |>
  cor(use = "pairwise.complete.obs")


plot_corr_heatmap <- function(cor_mat, title_text) {

  cor_df <- as.data.frame(cor_mat)
  cor_df$var1 <- rownames(cor_df)

  long_cor <- tidyr::pivot_longer(
    cor_df,
    cols = -var1,
    names_to = "var2",
    values_to = "correlation"
  )

  ggplot(long_cor, aes(x = var1, y = var2, fill = correlation)) +
    geom_tile(color = "white") +
    scale_fill_distiller(
      palette = "RdBu",
      direction = 1,
      limits = c(-1, 1),
      name = "Correlation"
    ) +
    coord_fixed() +
    theme_minimal(base_size = 12) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      axis.text.y = element_text(face = "bold"),
      plot.title  = element_text(face = "bold", size = 16)
    ) +
    labs(
      title = title_text,
      x = "",
      y = ""
    )
}


plot_corr_heatmap(cor_mat_60_90, "Correlation Structure (1960–1990)")


```


```{r}
plot_corr_heatmap(cor_mat_90_23, "Correlation Structure (1990–2023)")

```
## PCA & Similartiy between Countries

```{r}
# variables to use
vars_pca <- c(
  "fertility_rate",
  "gdp_capita_const",
  "flfpr",
  "emp_to_pop",
  "net_migration"
)

# pivot wider and average across 1990–2023
pca_data <- master_long |>
  filter(
    variable %in% vars_pca,
    year >= 1990,
    year <= end_year
  ) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(names_from = variable, values_from = value) |>
  left_join(country_lookup, by = "country") |>
  group_by(country_name, region) |>
  summarize(across(all_of(vars_pca), ~ mean(.x, na.rm = TRUE)), .groups = "drop")

library(ggfortify)

# PCA on scaled variables
pca_model <- prcomp(
  pca_data |> select(all_of(vars_pca)),
  scale = TRUE,
  center = TRUE
)

autoplot(
  pca_model,
  data = pca_data,
  colour = "region",
  label = TRUE,
  label.size = 3,
  loadings = TRUE,
  loadings.label = TRUE,
  loadings.colour = "black",
  loadings.label.size = 3
) +
  scale_color_brewer(palette = "Set2") +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(size = 16, face = "bold")
  ) +
  labs(
    title = "PCA Biplot of Demographic & Economic Indicators (Avg. 1990–2023)",
    colour = "Region"
  )


```
```{r}
# hierarchical clustering on scaled variables
dist_mat <- pca_data |>
  select(all_of(vars_pca)) |>
  scale() %>%
  dist()

hc <- hclust(dist_mat, method = "ward.D2")

plot(
  hc,
  labels = pca_data$country_name,
  main = "Hierarchical Clustering of Countries (Avg. 1990–2023)",
  xlab = "",
  sub = "",
  cex = 0.9
)

```
EXPLAIN HOW TO INTERPRET. EXPLAIN TAKEAWAYS


## Deep dive: South Korea

```{r}
#| fig-width: 10
#| fig-height: 6
#| fig-dpi: 300

korea_fert <- master_long |>
  filter(country == "KOR", variable == "fertility_rate") |>
  left_join(country_lookup, by = "country")

p_fert_kor <- ggplot(korea_fert, aes(x = year, y = value)) +
  geom_hline(yintercept = 2.1, linetype = "dashed", color = "grey50") +
  geom_line(color = "#2c7fb8", linewidth = 1) +
  scale_y_continuous("Fertility rate", limits = c(0, NA)) +
  scale_x_continuous("Year", breaks = seq(1960, 2020, by = 10)) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Fertility Rate"
  )


korea_gdp <- master_long |>
  filter(country == "KOR", variable == "gdp_capita_const") |>
  left_join(country_lookup, by = "country")

p_gdp_kor <- ggplot(korea_gdp, aes(x = year, y = value)) +
  geom_line(color = "#1b9e77", linewidth = 1) +
  scale_y_log10(
    "GDP per capita (log scale)",
    labels = scales::label_number(scale_cut = scales::cut_si(""))
  ) +
  scale_x_continuous("Year", breaks = seq(1960, 2020, by = 10)) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Economic Growth"
  )

korea_labor <- master_long |>
  filter(country == "KOR", variable %in% c("flfpr", "emp_to_pop")) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(names_from = variable, values_from = value) |>
  filter(!is.na(flfpr), !is.na(emp_to_pop)) |>
  mutate(
    flfpr_z   = scale(flfpr)[, 1],
    emp_z     = scale(emp_to_pop)[, 1]
  ) |>
  tidyr::pivot_longer(
    cols = c(flfpr_z, emp_z),
    names_to = "series",
    values_to = "z_value"
  ) |>
  mutate(
    series = dplyr::recode(
      series,
      flfpr_z = "Female labor force participation (z)",
      emp_z   = "Employment-to-population (z)"
    )
  )

p_labor_kor <- ggplot(korea_labor, aes(x = year, y = z_value, color = series)) +
  geom_line(linewidth = 1) +
  scale_color_manual(
    values = c(
      "Female labor force participation (z)" = "#d95f02",
      "Employment-to-population (z)"         = "#7570b3"
    ),
    name = ""
  ) +
  scale_x_continuous("Year", breaks = seq(1990, 2020, by = 10)) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Labor Market Trends",
    y = "Standardized level"
  ) + 
  theme(legend.position = "bottom")

korea_popmig <- master_long |>
  filter(country == "KOR", variable %in% c("total_population", "net_migration")) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(names_from = variable, values_from = value) |>
  arrange(year) |>
  mutate(
    pop_growth_pct = (total_population - dplyr::lag(total_population)) /
                     dplyr::lag(total_population) * 100
  ) |>
  filter(!is.na(pop_growth_pct))

korea_popmig_long <- korea_popmig |>
  mutate(
    mig_z  = scale(net_migration)[, 1],
    popg_z = scale(pop_growth_pct)[, 1]
  ) |>
  tidyr::pivot_longer(
    cols = c(mig_z, popg_z),
    names_to = "series",
    values_to = "z_value"
  ) |>
  mutate(
    series = dplyr::recode(
      series,
      mig_z  = "Net migration (z)",
      popg_z = "Population growth % (z)"
    )
  )

p_popmig_kor <- ggplot(korea_popmig_long, aes(x = year, y = z_value, color = series)) +
  geom_line(linewidth = 1) +
  scale_color_manual(
    values = c(
      "Net migration (z)"        = "#1b9e77",
      "Population growth % (z)"  = "#e7298a"
    ),
    name = ""
  ) +
  theme_minimal(base_size = 12) +
  scale_x_continuous("Year", breaks = seq(1960, 2020, by = 10)) +
  labs(
    title = "Migration & Population Growth",
    y = "Standardized level"
  )


library(patchwork)

(p_fert_kor | p_gdp_kor) /
(p_labor_kor | p_popmig_kor)

```

## Deep dive: India

```{r}
#| fig-width: 10
#| fig-height: 6
#| fig-dpi: 300

india_fert <- master_long |>
  filter(country == "IND", variable == "fertility_rate") |>
  left_join(country_lookup, by = "country")

p_fert_ind <- ggplot(india_fert, aes(x = year, y = value)) +
  geom_hline(yintercept = 2.1, linetype = "dashed", color = "grey50") +
  geom_line(color = "#2c7fb8", linewidth = 1) +
  scale_y_continuous("Fertility rate", limits = c(0, NA)) +
  scale_x_continuous("Year", breaks = seq(1960, 2020, by = 10)) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Fertility Rate"
  )


india_gdp <- master_long |>
  filter(country == "IND", variable == "gdp_capita_const") |>
  left_join(country_lookup, by = "country")

p_gdp_ind <- ggplot(india_gdp, aes(x = year, y = value)) +
  geom_line(color = "#1b9e77", linewidth = 1) +
  scale_y_log10(
    "GDP per capita (log scale)",
    labels = scales::label_number(scale_cut = scales::cut_si(""))
  ) +
  scale_x_continuous("Year", breaks = seq(1960, 2020, by = 10)) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Economic Growth"
  )


india_labor <- master_long |>
  filter(country == "IND", variable %in% c("flfpr", "emp_to_pop")) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(names_from = variable, values_from = value) |>
  filter(!is.na(flfpr), !is.na(emp_to_pop)) |>
  mutate(
    flfpr_z = scale(flfpr)[, 1],
    emp_z   = scale(emp_to_pop)[, 1]
  ) |>
  tidyr::pivot_longer(
    cols = c(flfpr_z, emp_z),
    names_to = "series",
    values_to = "z_value"
  ) |>
  mutate(
    series = dplyr::recode(
      series,
      flfpr_z = "Female labor force participation (z)",
      emp_z   = "Employment-to-population (z)"
    )
  )

p_labor_ind <- ggplot(india_labor, aes(x = year, y = z_value, color = series)) +
  geom_line(linewidth = 1) +
  scale_color_manual(
    values = c(
      "Female labor force participation (z)" = "#d95f02",
      "Employment-to-population (z)"         = "#7570b3"
    ),
    name = ""
  ) +
  scale_x_continuous("Year", breaks = seq(1990, 2020, by = 10)) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Labor Market Trends",
    y = "Standardized level"
  ) + 
  theme(legend.position = "bottom")


india_popmig <- master_long |>
  filter(country == "IND", variable %in% c("total_population", "net_migration")) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(names_from = variable, values_from = value) |>
  arrange(year) |>
  mutate(
    pop_growth_pct = (total_population - dplyr::lag(total_population)) /
                     dplyr::lag(total_population) * 100
  ) |>
  filter(!is.na(pop_growth_pct))

india_popmig_long <- india_popmig |>
  mutate(
    mig_z  = scale(net_migration)[, 1],
    popg_z = scale(pop_growth_pct)[, 1]
  ) |>
  tidyr::pivot_longer(
    cols = c(mig_z, popg_z),
    names_to = "series",
    values_to = "z_value"
  ) |>
  mutate(
    series = dplyr::recode(
      series,
      mig_z  = "Net migration (z)",
      popg_z = "Population growth % (z)"
    )
  )

p_popmig_ind <- ggplot(india_popmig_long, aes(x = year, y = z_value, color = series)) +
  geom_line(linewidth = 1) +
  scale_color_manual(
    values = c(
      "Net migration (z)"        = "#1b9e77",
      "Population growth % (z)"  = "#e7298a"
    ),
    name = ""
  ) +
  theme_minimal(base_size = 12) +
  scale_x_continuous("Year", breaks = seq(1960, 2020, by = 10)) +
  labs(
    title = "Migration & Population Growth",
    y = "Standardized level"
  )


library(patchwork)

(p_fert_ind | p_gdp_ind) /
(p_labor_ind | p_popmig_ind)

```


```{r}
#| fig-width: 10
#| fig-height: 6
#| fig-dpi: 300

poland_fert <- master_long |>
  filter(country == "POL", variable == "fertility_rate") |>
  left_join(country_lookup, by = "country")

p_fert_pol <- ggplot(poland_fert, aes(x = year, y = value)) +
  geom_hline(yintercept = 2.1, linetype = "dashed", color = "grey50") +
  geom_line(color = "#2c7fb8", linewidth = 1) +
  scale_y_continuous("Fertility rate", limits = c(0, NA)) +
  scale_x_continuous("Year", breaks = seq(1960, 2020, by = 10)) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Fertility Rate"
  )


poland_gdp <- master_long |>
  filter(country == "POL", variable == "gdp_capita_const") |>
  left_join(country_lookup, by = "country")

p_gdp_pol <- ggplot(poland_gdp, aes(x = year, y = value)) +
  geom_line(color = "#1b9e77", linewidth = 1) +
  scale_y_log10(
    "GDP per capita (log scale)",
    labels = scales::label_number(scale_cut = scales::cut_si(""))
  ) +
  scale_x_continuous("Year", breaks = seq(1960, 2020, by = 10)) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Economic Growth"
  )


poland_labor <- master_long |>
  filter(country == "POL", variable %in% c("flfpr", "emp_to_pop")) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(names_from = variable, values_from = value) |>
  filter(!is.na(flfpr), !is.na(emp_to_pop)) |>
  mutate(
    flfpr_z = scale(flfpr)[, 1],
    emp_z   = scale(emp_to_pop)[, 1]
  ) |>
  tidyr::pivot_longer(
    cols = c(flfpr_z, emp_z),
    names_to = "series",
    values_to = "z_value"
  ) |>
  mutate(
    series = dplyr::recode(
      series,
      flfpr_z = "Female labor force participation (z)",
      emp_z   = "Employment-to-population (z)"
    )
  )

p_labor_pol <- ggplot(poland_labor, aes(x = year, y = z_value, color = series)) +
  geom_line(linewidth = 1) +
  scale_color_manual(
    values = c(
      "Female labor force participation (z)" = "#d95f02",
      "Employment-to-population (z)"         = "#7570b3"
    ),
    name = ""
  ) +
  scale_x_continuous("Year", breaks = seq(1990, 2020, by = 10)) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Labor Market Trends",
    y = "Standardized level"
  ) + 
  theme(legend.position = "bottom")


poland_popmig <- master_long |>
  filter(country == "POL", variable %in% c("total_population", "net_migration")) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(names_from = variable, values_from = value) |>
  arrange(year) |>
  mutate(
    pop_growth_pct = (total_population - dplyr::lag(total_population)) /
                     dplyr::lag(total_population) * 100
  ) |>
  filter(!is.na(pop_growth_pct))

poland_popmig_long <- poland_popmig |>
  mutate(
    mig_z  = scale(net_migration)[, 1],
    popg_z = scale(pop_growth_pct)[, 1]
  ) |>
  tidyr::pivot_longer(
    cols = c(mig_z, popg_z),
    names_to = "series",
    values_to = "z_value"
  ) |>
  mutate(
    series = dplyr::recode(
      series,
      mig_z  = "Net migration (z)",
      popg_z = "Population growth % (z)"
    )
  )

p_popmig_pol <- ggplot(poland_popmig_long, aes(x = year, y = z_value, color = series)) +
  geom_line(linewidth = 1) +
  scale_color_manual(
    values = c(
      "Net migration (z)"        = "#1b9e77",
      "Population growth % (z)"  = "#e7298a"
    ),
    name = ""
  ) +
  theme_minimal(base_size = 12) +
  scale_x_continuous("Year", breaks = seq(1960, 2020, by = 10)) +
  labs(
    title = "Migration & Population Growth",
    y = "Standardized level"
  )


library(patchwork)

(p_fert_pol | p_gdp_pol) /
(p_labor_pol | p_popmig_pol)

```



```{r}
#| fig-width: 10
#| fig-height: 6
#| fig-dpi: 300

nigeria_fert <- master_long |>
  filter(country == "NGA", variable == "fertility_rate") |>
  left_join(country_lookup, by = "country")

p_fert_nga <- ggplot(nigeria_fert, aes(x = year, y = value)) +
  geom_hline(yintercept = 2.1, linetype = "dashed", color = "grey50") +
  geom_line(color = "#2c7fb8", linewidth = 1) +
  scale_y_continuous("Fertility rate", limits = c(0, NA)) +
  scale_x_continuous("Year", breaks = seq(1960, 2020, by = 10)) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Fertility Rate"
  )


nigeria_gdp <- master_long |>
  filter(country == "NGA", variable == "gdp_capita_const") |>
  left_join(country_lookup, by = "country")

p_gdp_nga <- ggplot(nigeria_gdp, aes(x = year, y = value)) +
  geom_line(color = "#1b9e77", linewidth = 1) +
  scale_y_log10(
    "GDP per capita (log scale)",
    labels = scales::label_number(scale_cut = scales::cut_si(""))
  ) +
  scale_x_continuous("Year", breaks = seq(1960, 2020, by = 10)) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Economic Growth"
  )


nigeria_labor <- master_long |>
  filter(country == "NGA", variable %in% c("flfpr", "emp_to_pop")) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(names_from = variable, values_from = value) |>
  filter(!is.na(flfpr), !is.na(emp_to_pop)) |>
  mutate(
    flfpr_z = scale(flfpr)[, 1],
    emp_z   = scale(emp_to_pop)[, 1]
  ) |>
  tidyr::pivot_longer(
    cols = c(flfpr_z, emp_z),
    names_to = "series",
    values_to = "z_value"
  ) |>
  mutate(
    series = dplyr::recode(
      series,
      flfpr_z = "Female labor force participation (z)",
      emp_z   = "Employment-to-population (z)"
    )
  )

p_labor_nga <- ggplot(nigeria_labor, aes(x = year, y = z_value, color = series)) +
  geom_line(linewidth = 1) +
  scale_color_manual(
    values = c(
      "Female labor force participation (z)" = "#d95f02",
      "Employment-to-population (z)"         = "#7570b3"
    ),
    name = ""
  ) +
  scale_x_continuous("Year", breaks = seq(1990, 2020, by = 10)) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Labor Market Trends",
    y = "Standardized level"
  ) + 
  theme(legend.position = "bottom")


nigeria_popmig <- master_long |>
  filter(country == "NGA", variable %in% c("total_population", "net_migration")) |>
  select(country, year, variable, value) |>
  tidyr::pivot_wider(names_from = variable, values_from = value) |>
  arrange(year) |>
  mutate(
    pop_growth_pct = (total_population - dplyr::lag(total_population)) /
                     dplyr::lag(total_population) * 100
  ) |>
  filter(!is.na(pop_growth_pct))

nigeria_popmig_long <- nigeria_popmig |>
  mutate(
    mig_z  = scale(net_migration)[, 1],
    popg_z = scale(pop_growth_pct)[, 1]
  ) |>
  tidyr::pivot_longer(
    cols = c(mig_z, popg_z),
    names_to = "series",
    values_to = "z_value"
  ) |>
  mutate(
    series = dplyr::recode(
      series,
      mig_z  = "Net migration (z)",
      popg_z = "Population growth % (z)"
    )
  )

p_popmig_nga <- ggplot(nigeria_popmig_long, aes(x = year, y = z_value, color = series)) +
  geom_line(linewidth = 1) +
  scale_color_manual(
    values = c(
      "Net migration (z)"        = "#1b9e77",
      "Population growth % (z)"  = "#e7298a"
    ),
    name = ""
  ) +
  theme_minimal(base_size = 12) +
  scale_x_continuous("Year", breaks = seq(1960, 2020, by = 10)) +
  labs(
    title = "Migration & Population Growth",
    y = "Standardized level"
  )


library(patchwork)

(p_fert_nga | p_gdp_nga) /
(p_labor_nga | p_popmig_nga)

```

